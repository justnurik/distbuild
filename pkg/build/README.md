# build

**Управление графом задач сборки с детерминированным кешированием**

---

## Назначение

Пакет `build` реализует ядро системы сборки, предоставляя:
- Модель описания задач (джобов) и их зависимостей
- Механизм детерминированного вычисления идентификаторов задач
- Поддержку различных типов команд выполнения
- Интеграцию с системой кеширования артефактов

---

## Ключевые концепции

### 1. Детерминированная сборка
Каждая задача (`Job`) имеет уникальный `ID`, вычисляемый как хеш от:
- Всех входных файлов (`Inputs`)
- Параметров команд выполнения (`Cmds`)
- Идентификаторов зависимых задач (`Deps`)

Это гарантирует, что результат сборки однозначно определяется входными данными.

### 2. Типы команд
Поддерживаются два типа операций:

**Exec** - выполнение произвольной команды:
```go
Cmd{
    Exec: []string{"go", "build"},
    Environ: []string{"GOPATH=/app"},
    WorkingDirectory: "src/",
}
```

**Cat** - генерация файлов из шаблонов:
```go
Cmd{
    CatTemplate: "package main\n\nfunc main() {}",
    CatOutput:   "{{.OutputDir}}/main.go",
}
```

### 3. Контекстные переменные
Автоматическая подстановка в строках команд:
- `{{.OutputDir}}` - выходная директория задачи
- `{{.SourceDir}}` - директория с исходным кодом
- `{{index .Deps "id"}}` - путь к артефакту зависимости

---

## Основные компоненты

### Структура Job
```go
type Job struct {
    ID      ID      // Уникальный идентификатор
    Name    string  // Человекочитаемое имя
    Inputs  []string // Входные файлы
    Deps    []ID    // Зависимости
    Cmds    []Cmd   // Команды выполнения
}
```

### Граф сборки
```go
type Graph struct {
    SourceFiles map[ID]string // Мэппинг исходных файлов
    Jobs        []Job         // Все задачи графа
}
```

### Система подстановки переменных
Пример использования в команде:
```bash
go build -o {{.OutputDir}}/app {{index .Deps "a1b2c3"}}/lib.go
```

---

## Особенности реализации

1. **Кеширование артефактов**  
   Результаты задач сохраняются по их `ID`, что позволяет:
   - Пропускать выполнение идентичных задач
   - Повторно использовать артефакты между сборками

2. **Валидация графа**  
   Встроенные проверки на:
   - Циклические зависимости
   - Корректность ссылок на `Deps`
   - Существование указанных файлов в `Inputs`

---

## Пример использования

```go
// Создание задачи компиляции
compileJob := build.Job{
    ID:   computeHash(/*...*/),
    Name: "compile main",
    Inputs: []string{"src/main.go"},
    Cmds: []build.Cmd{
        {
            Exec: []string{"go", "build", "-o", "{{.OutputDir}}/app"},
            WorkingDirectory: "src/",
        },
    },
}

// Создание графа сборки
graph := build.Graph{
    Jobs: []build.Job{compileJob},
    SourceFiles: map[build.ID]string{
        fileID: "src/main.go",
    },
}
```
